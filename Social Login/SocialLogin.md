# 카카오 로그인

## 이해하기

### 카카오 로그인 이란?

카카오 계정으로 다양한 서비스에 로그인 할 수 있도록 하는 "소셜 로그인 서비스" 이다.

### OAuth

OAuth는 4가지 역할을 정의한다.

1. 리소스 소유자

2. 리소스 서버

3. 고객

4. 인증 서비

### 프로토콜 흐름

1. 클라이언트가 리소스 소유자에게 권한 부여 요청
2. 리소스 소유자는 클라이언트에게 권한 부여
3. 클라이언트는 인증을 통해 액세스 토큰을 요청
   3-1.권한 부여 서버 및 권한 부여를 제시
4. Authorization Server는 클라이언트를 인증하고 유효성 검사
   4-1. 권한 부여 및 유효한 경우 액세스 토큰을 발급
5. 클라이언트는 리소스에서 보호된 리소스를 요청
   5-1. 엑세스 토큰을 제시하여 서버를 인증
6. 리소스 서버는 액세스 토큰의 유효성을 검사하고 유효하면 요청을 처리

### 소셜 로그인

소셜 로그인을 사용하면 사용자가 소셜 계정으로 손쉽게 서비스에 로그인 할 수 있다.
서비스 ID 및 비밀번호를 입력받고 검증하는 과정을 직접 구현하지 않고도 사용자에 대한 인증과 인가를 간편하고 안전하게 처리 할 수 있다.
인증 :
ID와 비밀번호로 사용자 신원 확인
각 서비스에서 사용자가 소셜 계정으로 로그인 할 수 있는 기능 지원
서비스에서 각 사용자를 식별할 수 있는 고유한 회원번호 제공

인가 :
사용자 개인정보와 같은 자원(Resource)에 대한 접근 권한 획득
사용자 동의를 바탕으로 사용자 정보나 기능에 대한 접근 권한을 토큰 형태로 서비스에 부여

### 토큰

토큰은 사용자의 소셜 로그인 인증&인가 정보를 담은 "권한 증명"이다.
소셜 API 호출에 사용된다.
카카오 로그인은 엑세스 토큰(Access token) 리프레시 토큰(Refresh token) 두 종류의 토큰을 발금한다.

### 토큰 종류

1. 엑세스 토큰 : 사용자 인증, 소셜 API 호출 권한 부여 / 만료 시간 : Android, iOS : 12시간 JavaScript: 2 시간 REST API : 6시간
2. 리프레시 토큰 : 엑세스 토큰 재발급에 사용 - 유효한 리프레시 토큰이 있다면 사용자가 매번 카카오계정에 정보를 입력하거나 로그인 인증 절차를 거치지 않아도 엑세스 토큰 재발급 가능 / 2달 : 만료 시간 1달 남은 시점부터 갱신 가능
3. ID토큰 : 카카오 로그인 사용자의 인증 정보를 제공하는 토큰 / 엑세스 토큰과 동일

### 서비스 로그인 과정

#### 카카오 로그인

1. 사용자가 서비스에서 카카오 로그인 버튼을 클릭
2. 서비스는 카카오 인증 서버로 인가 코드 발급 요청
3. 카카오 인증 서버는 사용자에게 인증을 요청
   3-1. 카카오톡으로 로그인: 카카오톡 실행, 카카오톡에 연결된 카카오계정의 자격정보(Credentials)로 사용자 인증
   3-2. 카카오계정으로 로그인: 계정 정보를 입력해 로그인하는 화면 출력, 해당 카카오계정의 자격정보로 사용자 인증
4. 사용자 인증 성공 시 , 서비스 앱의 동의 화면을 사용자에게 출력
5. 사용자가 필수 동의 항목에 동의하고 로그인 요청
6. 카카오 인증 서버는 인가 코드를 발급하고 서비스 앱에 등록된 Redirect URI로 전달
7. 서비스는 전달받은 인가 코드로 토큰을 요청하여 받는다.

#### 회원 확인

1. 서비스는 카카오 로그인을 완료하여 발급받은 토큰을 사용자 정보 가져오기를 요청
2. 카카오 API 서버는 요청 시 사용된 트큰의 "유효성 검증" 요청을 처리하고 서비스에 응답
3. 서비스 서버는 카카오로부터 제공받은 사용자 정보로 해당 사용자가 서비스에 회원 가입되어 있는지 확인
   3-1. 이미 회원 가입된 사용자: Step 3의 서비스 로그인 단계 수행
   3-2. 아직 회원 가입되지 않은 사용자: 카카오에서 제공받은 사용자 정보로 서비스 데이터베이스에 회원 가입 처리

#### 서비스 로그인

1. 서비스 서버는 서비스 클라이언트에 해당 사용자의 로그인에 대한 세션을 발급
2. 서비스 클라이언트는 서비스 세션을 전달받아 로그인 완료 처리하고, 사용자를 로그인된 서비스 화면으로 이동

#### 연결&가입

연결은 카카오 플랫폼이 내부적으로 수행
카카오 플랫폼은 토큰 요청&발급 시점에서 사용자와 앱을 연결한다.

가입은 서비스가 직접 수행
서비스는 토큰 요청 및 발급을 통해 카카오 로그인을 완료한 후,(카카오 플랫폼이 사용자와 앱을 연결하고 나면) 가입 및 로그인 처리를 해야한다.

카카오 로그인한 사용자의 사용자 정보로 해당 사용자의 가입 여부를 확인하고, 미가입 사용자인 경우 서비스 약관 동의와 추가 정보 입력 절차를 거쳐 서비스 회원 데이터 베이스에 가입 처리 한다.

- 카카오는 2020년 12월 28일 부터 24시간 이내 서비스 최종 가입을 완료하지 않은 사용자를 대상으로 연결 끊기 처리가 매일 진행된다.

#### 로그아웃

사용자가 카카오 로그인을 통해 발급받은 "토큰을 만료"시키는 기능
사용자가 서비스 로그아웃을 요청한 경우 로그아웃을 통해 토큰을 만료시켜야 정상적으로 서비스 로그아웃 처리

로그아웃 과정 :
엑세스 토큰으로 요청
Kakao SDK를 통해 로그아웃 요청 시 액세스 토큰으로 요청만 가능
해당 액세스 토큰만 만료 처리
만료된 액세스 토큰을 사용하는 모든 기기에서 로그아웃
어드민 키로 요청
REST API를 통한 로그아웃 요청 시에만 어드민 키로 요청 가능
해당 사용자의 모든 토큰 만료 처리
모든 기기에서 로그아웃됨

---

## 설정하기

1. 카카오 로그인 활성화 설정
2. OpenID Connect 활성화 설정
3. Redirect URI 등록
4. 동의 화면 미리보기

카카오 로그인 활성화 설정 on : 카카오 로그인을 사용 중인 경우에만 OpenID Connect를 사용할 수 있습니다.
OpenID Connect 활성화 설정 on

- [OpenID Connect 활성화] 설정을 [OFF]로 변경하면, 설정 변경 시점부터 ID 토큰이 발급되지 않습니다. 서비스에서 ID 토큰을 사용 중인 경우에는 로그인 기능에 문제를 일으킬 수 있으므로 주의합니다.

### Redirect URI 등록

REST API또는 Kakao SDK for JavaScript로 카카오 로그인을 사용한다면 Redirect URI 를 반드시 등록해야 한다.
Redirect URI는 Oauth 2.0을 기반으로 동작하는 카카오 로그인의 핵심 요소이다.
카카오 로그인은 서비스 로그인 과정에서 Redirect URI를 통해 서비스에서 요청한 "인가 코드"와"토큰"을 전달한다.
Redirect URI를 올바르게 등록하지 않은 경우, KOE006에러 발생

### Redirect URI 규칙

Redirect URI는 최대 10개까지 등록할 수 있습니다.
Redirect URI는 HTTP 및 HTTPS 프로토콜, 80, 443 포트를 허용합니다.
Redirect URI는 HTTP, HTTPS 프로토콜을 구분하므로 각각 등록해야 합니다.

- Redirect URI 활용
  카카오 로그인 후 랜딩 페이지, 추가 정보 입력 페이지 등 상황에 맞는 서비스 페이지로 이동할 수 있도록 여러 개의 Redirect URI를 등록할 수 있습니다.
  Redirect URI는 경로(path)에 임의의 파라미터를 포함할 수 없습니다. 로그인 과정 중 특정 정보를 유지하거나 전달하려면 state 파라미터를 활용합니다. state 파라미터에 대한 정보는 인가 코드 받기에서 확인할 수 있습니다.
  10개를 초과하는 Redirect URI 등록이 필요한 경우, 데브톡으로 문의합니다.

### 사용자 프로퍼티

[내 애플리케이션] > [카카오 로그인] > [사용자 프로퍼티]에서 사용자 프로퍼티 키를 등록할 수 있습니다. 서비스마다 총 5개의 사용자 프로퍼티 키를 등록할 수 있습니다.

---

## 보안

### Client Secret

REST API 방식으로 카카오 로그인 사용 시, 클라이언트 시크릿(Client secret) 코드를 사용해 보안을 강화할 수 있습니다. [내 애플리케이션] > [카카오 로그인] > [보안]에서 [코드 생성] 버튼을 눌러 클라이언트 시크릿 코드를 발급받을 수 있습니다.

클라이언트 시크릿 코드를 발급받아 사용하도록 설정한 후에는 토큰 받기와 토큰 갱신하기 요청 시 client_secret 파라미터로 발급된 클라이언트 시크릿 코드 값을 전달해야만 토큰을 발급받을 수 있습니다. 해당 파라미터를 사용하지 않았거나 잘못된 클라이언트 시크릿 코드 값을 전달한 경우 KOE010 에러가 발생합니다.

클라이언트 시크릿 코드가 유출된 경우, [코드]의 [재발급] 버튼을 눌러 새로운 코드를 발급받을 수 있습니다. 운영 중인 서비스에서 코드 재발급 시, 기존 코드를 사용한 토큰 발급 요청이 모두 실패하게 되므로 주의합니다.

### Logout Redirect URI 등록

[제품 설정] > [카카오 로그인] > [고급] > [Logout Redirect URI]에서 Logout Redirect URI를 등록해야 합니다.
Logout Redirect URI는 HTTP/HTTPS 프로토콜 및 80, 443 포트를 지원하며, HTTP/HTTPS 프로토콜을 구분하므로 각각 등록해야 합니다. 최대 10개의 Logout Redirect URI 등록이 가능하며, 10개 초과 등록이 필요한 경우 데브톡으로 문의합니다.

---

## REST API

### REST API 로그인 과정

[인가 코드 받기]

1. Service Client 카카오 로그인 요청
2. Service Server -> Kakao Auth Server : GET / oauth / authorize
3. Kakao Auth Server -> Service Client : 카카오 계정 로그인 요청
4. Service Client -> Kakao Auth Server : 카카오 계정 로그인
5. Kakao Auth Server : 사용자 인증 앱 설정 확인
6. Kakao Auth Server -> Service Client : 동의 화면 출력
7. Service Client -> Kakao Auth Server : 동의하고 계속하기
8. Kakao Auth Server -> Service Serve : 302 Redirect URI로 인가 코드 전달

[토큰 받기] 9. Service Serve -> Kakao Auth Server : POST / oauth / token 10. Kakao Auth Server -> Service Serve : 토큰 발급

[사용자 로그인 처리] 11. Service Serve : 발급받은 토큰으로 사용자 정보 조회 & 서비스 회원 정보 확인 또는 가입 처리
11-1. \*OpenID Connect 사용시 Service Serve : ID 토큰 유효성 검증 12. Service Serve -> Server Client : 로그인 완료

### 카카오 로그인

#### 인가 코드 받기

기본 정보 :

GET /oauth/authorize?client_id=${REST_API_KEY}&redirect_uri=${REDIRECT_URI}&response_type=code HTTP/1.1
Host: kauth.kakao.com

#### 인가 코드 발급

카카오 로긘 동의 화면을 호출하고, 사용자 동의를 거쳐 인가 코드를 발급한다.
동의 화면은 설정된 동의 항목을 사용자에게 인가(동의) 구한다.
인가 코드는 동의 화면을 통해 인가받은 동의 항목 정보를 갖고 있으며, 인가 코드를 사용해 "토큰 받기"를 요청할 수 있다.

인가 코드 받기 요청은 웹 브라우저 또는 웹뷰의 카카오 계정 세션 존재 여부에 따라 다르게 동작
_ 카카오계정 세션 없음 : 사용자가 카카오 계정 정보를 입력하거나 카카오톡으로 로그인하는 인증 과정을 거쳐 동의 화면을 출력
_ 카카오계정 세션 있음 : 카카오 로그인 과정을 거치지 않고 바로 동의 화면을 출력

사용자는 동의 화면에서 서비스 이용에 필요한 동의 항목에 동의하고 로그인 하거나 취소 할 수 있다.
카카오 인증 서버는 사용자의 선택에 따라 요청 처리 결과를 담은 "쿼리 스트링"을 redirect\*uri로 HTTP 302 리다이렉트(Redirect)한다.

- 사용자가 모든 필수 동의 항목에 동의하고 [동의하고 계속하기] 버튼을 누른 경우
  _ -> redirect_uri로 인가 코드를 담은 쿼리 스트링 전달
  _ 사용자가 동의 화면에서 [취소] 버튼을 눌러 로그인을 취소한 경우
  \_ -> redirect_uri로 에러 정보를 담은 쿼리 스트링 전달
